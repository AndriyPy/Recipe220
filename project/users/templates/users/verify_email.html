{% extends 'users/base.html' %}
{% load static %}

{% block title %}SmartRecipe - Confirm Your Email{% endblock %}

{% block extra_head %}
<style>
    .verify-wrapper { display: flex; justify-content: center; align-items: center; min-height: calc(100vh - 80px); padding: 40px 20px; background: #F9F9F7; }
    .verify-card { background: white; width: 100%; max-width: 550px; padding: 50px 40px; border-radius: 50px; box-shadow: 0 15px 40px rgba(0,0,0,0.08); text-align: center; }
    .icon-box { background: #2D4635; color: white; width: 65px; height: 65px; border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto 30px; font-size: 26px; }
    .verify-card h1 { font-family: 'Playfair Display', serif; color: #2D4635; font-size: 42px; margin-bottom: 20px; }
    .verify-card p { color: #666; line-height: 1.6; margin-bottom: 5px; font-size: 16px; }
    .verify-card strong { color: #F58220; }

    .code-input-field {
        background: #f7f7f7;
        border: 2px solid #E0E0E0;
        border-radius: 20px;
        padding: 25px 20px;
        width: 100%;
        font-size: 48px;
        letter-spacing: 15px;
        text-align: center;
        color: #2D4635;
        margin: 40px 0 30px;
        transition: all 0.3s ease;
        font-weight: 600;
        font-family: monospace;
    }
    .code-input-field:focus {
        outline: none;
        border-color: #F58220;
        background: #ffffff;
        box-shadow: 0 0 0 3px rgba(245,130,32,0.1);
    }
    .code-input-field::placeholder {
        color: #ccc;
        letter-spacing: 5px;
        font-size: 24px;
    }

    .verify-btn {
        background: #F58220;
        color: white;
        border: none;
        border-radius: 15px;
        padding: 18px;
        width: 100%;
        font-weight: 700;
        font-size: 16px;
        letter-spacing: 1px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        transition: all 0.3s;
    }
    .verify-btn:hover {
        background: #e6731a;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(245,130,32,0.3);
    }

    .simmering-text {
        font-style: italic;
        color: #89A08B !important;
        margin-top: 40px !important;
        font-size: 15px;
    }

    .menu-link {
        display: inline-block;
        margin-top: 30px;
        color: #2D4635;
        text-decoration: none;
        font-weight: 600;
        font-size: 14px;
        transition: color 0.3s;
    }
    .menu-link:hover {
        color: #F58220;
    }

    .errorlist {
        list-style: none;
        padding: 0;
        color: #dc3545;
        font-size: 14px;
        margin: 10px 0;
        text-align: center;
    }

    .messages {
        margin: 20px 0;
    }

    .message-success {
        background: #d4edda;
        color: #155724;
        padding: 12px;
        border-radius: 10px;
        margin-bottom: 10px;
    }

    .message-error {
        background: #f8d7da;
        color: #721c24;
        padding: 12px;
        border-radius: 10px;
        margin-bottom: 10px;
    }

    .resend-link {
        display: inline-block;
        margin-top: 20px;
        color: #F58220;
        text-decoration: none;
        font-weight: 600;
        font-size: 14px;
    }

    .resend-link:hover {
        text-decoration: underline;
    }

    @media (max-width: 600px) {
        .verify-card { padding: 40px 25px; }
        .verify-card h1 { font-size: 32px; }
        .code-input-field { font-size: 36px; letter-spacing: 10px; }
    }
</style>
{% endblock %}

{% block content %}
<div class="verify-wrapper">
    <div class="verify-card">
        <div class="icon-box">
            <i class="fa-solid fa-envelope"></i>
        </div>

        <h1>Confirm Your Email</h1>

        <p>We've sent a unique verification code to</p>
        <p><strong>{{ masked_email }}</strong></p>
        <p>Enter it below to activate your account.</p>

        {% if messages %}
        <div class="messages">
            {% for message in messages %}
            <div class="message-{% if message.tags %}{{ message.tags }}{% else %}info{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <form method="post" id="verify-form">
            {% csrf_token %}

            <div style="margin-bottom: 20px;">
                {{ form.code }}
                {% if form.code.errors %}
                <ul class="errorlist">
                    {% for error in form.code.errors %}
                    <li>{{ error }}</li>
                    {% endfor %}
                </ul>
                {% endif %}
            </div>

            <button type="submit" class="verify-btn" id="submit-btn">
                VERIFY & EXPLORE <i class="fa-regular fa-circle-check"></i>
            </button>
        </form>

        <p class="simmering-text">
            <i class="fa-solid fa-clock"></i>
            Your code is simmering and will be served shortly!
        </p>

        <a href="/" class="menu-link">
            <i class="fa-solid fa-arrow-left"></i>
            Go to main menu
        </a>

        <a href="#" class="resend-link" onclick="resendCode(); return false;">
            Didn't receive the code? Resend
        </a>
    </div>
</div>

<script>
    // Автоматичне форматування коду
    const codeInput = document.querySelector('input[name="code"]');
    if (codeInput) {
        codeInput.classList.add('code-input-field');
        codeInput.setAttribute('placeholder', '0 0 0 0 0 0');
        codeInput.setAttribute('maxlength', '6');
        codeInput.setAttribute('inputmode', 'numeric');
        codeInput.setAttribute('pattern', '[0-9]*');

        // Автоматично переходити до наступного поля після введення 6 цифр
        codeInput.addEventListener('input', function(e) {
            this.value = this.value.replace(/[^0-9]/g, '');
            if (this.value.length === 6) {
                document.getElementById('submit-btn').focus();
            }
        });
    }

    // Функція для повторного відправлення коду
    function resendCode() {
        fetch('/resend-verification/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('New verification code has been sent to your email.');
            } else {
                alert('Error sending code. Please try again later.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    }

    // Блокування кнопки після відправки
    document.getElementById('verify-form').addEventListener('submit', function() {
        const btn = document.getElementById('submit-btn');
        btn.disabled = true;
        btn.innerHTML = 'VERIFYING... <i class="fa-solid fa-spinner fa-spin"></i>';
    });
</script>
{% endblock %}
